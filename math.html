<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=1024">
  <title>math</title>
  <link rel="stylesheet" type="text/css" href="css/index.css">
  <script src="js/generic.js"></script>
  <script src="js/globals.js"></script>
  <script src="js/main.js"></script>
</head>
<body>
	<br>
	<table id="tb3">
		<col width="5%"><col width="10%"><col width="85%">
		<thead><tr><th colspan="3">math</th></tr></thead>
		<!--<tr><td colspan="3"><hr></td></tr>
		<tr><td colspan="3">HASHES & CODES</td></tr>-->
		<tr><td colspan="2">[excludes tzp] combined</td><td class="c mono" id="hash0"></td></tr>
		<tr><td colspan="2">function</td><td class="c mono" id="hash1"></td></tr>
		<tr><td colspan="2">polyfill</td><td class="c mono" id="hash2"></td></tr>
		<tr><td colspan="2"></td><td class="c mono">---</td></tr>
		<tr><td colspan="2"><span class="s12">tzp</span></td><td class="c mono" id="tzphash"></td></tr>
		<tr><td colspan="3" class="center"></td></tr>

		<tr><td colspan="3"><hr></td></tr>
		<tr><td colspan="3">ANALYSIS</td></tr>
		<tr><td colspan="2"></td><td class="s3">vs control [FF78-64bit Win7-64bit]</td></tr>
		<tr><td colspan="2"></td><td class="mono">denoted in <span class="s1">pale red</span></td></tr>
		<tr><td colspan="2">function</td><td class="c mono spaces" id="diff1"></td></tr>
		<tr><td colspan="2">polyfill</td><td class="c mono spaces" id="diff2"></td></tr>
		<tr><td colspan="2">test no's in play</td><td class="c mono" id="num"></td></tr>
		<tr><td colspan="3" class="center"></td></tr>

		<tr><td colspan="2"></td><td class="s3">polyfill vs function</td></tr>
		<tr><td colspan="2"></td><td class="mono">denoted with <span class = "s1">[match]</span></td></tr>
		<tr><td colspan="2">diffs</td><td class="c mono spaces" id="diff0"></td></tr>
		<tr><td colspan="3" class="center"></td></tr>

		<tr><td colspan="3"><hr></td></tr>
		<tr><td colspan="3"><button class="btn0 btn" onClick="copyclip(`mathdata`)">[ copy to clipboard ]</button> DATA</td></tr>
		<tr><td></td><td colspan="2" class="c mono spaces" id="mathdata"></td></tr>
	</table>
	<br>

<script>
'use strict';

var tzpdisplay = [],
	tzpcode = "",
	tzphash = ""

function get_tzp() {
	// TZP ECMA 1st edition
	let list = ['1e251','1e140','1e12','1e130','1e272','1e0','1e284','1e75'],
		res = []
	for (let i=0; i < list.length; i++) {
		let item = "cos("+ list[i] + ")"
			item = item.padStart(12)
		let r = Math.cos(list[i]) 
		res.push(r)
		tzpdisplay.push(s12 + item + sc +": "+ r)
	}
	tzphash = sha1(res.join("-"))
	if ("undefined" != typeof InstallTrigger) {isFF = true}
	if (isFF) {
		// known FF hashes (os)
		if (tzphash == "46f7c2bbe55a2cd28252d059604f8c3bac316c23") {tzpcode="A"}
		else if (tzphash == "8464b989070dcff22c136e4d0fe21d466b708ece") {tzpcode="B"}
		else if (tzphash == "97eee44856b0d2339f7add0d22feb01bcc0a430e") {tzpcode="C"}
		else if (tzphash == "96895e004b623552b9543dcdc030640d1b108816") {tzpcode="D"}
		else if (tzphash == "06a01549b5841e0ac26c875b456a33f95b5c5c11") {tzpcode="E"}
		else if (tzphash == "ae434b101452888b756da5916d81f68adeb2b6ae") {tzpcode="F"}
		else if (tzphash == "19df0b54c852f35f011187087bd3a0dce12b4071") {tzpcode="G"}
		else if (tzphash == "8ee641f01271d500e5c1d40e831232214c0bbbdc") {tzpcode="H"}
		if (tzpcode == "") {
			tzpcode = zNEW
		} else {
			tzpcode = s12 + "["+ tzpcode +"]" + sc
		}
	}
}

// TEST ARRAY
var n = 0.123
var bigN = 5.860847362277284e+38
var fns = [
	// [item, function, value, description, control, poly1 control, poly2 control]
	// control value is FF78 64bit on Windows7 64bit
	[ 20,  'acos', [n], n, 1.4474840516030247],
	[ 21,  'acos', [Math.SQRT1_2], "Math.SQRT1_2", 0.7853981633974483],

	[ 40, 'acosh', [1e308], "1e300", 709.889355822726, "Infinity"],
	[ 41, 'acosh', [Math.PI], "Math.PI", 1.811526272460853, 1.8115262724608532],
	[ 42, 'acosh', [Math.SQRT2], "Math.SQRT2", 0.881373587019543, 0.8813735870195432],

	[ 60,  'asin', [n], n, 0.12331227519187199],

	[ 80, 'asinh', [1e300], "1e300", 691.4686750787736, 691.4686750787736],
	[ 81, 'asinh', [Math.PI], "Math.PI", 1.8622957433108482, 1.885022066017804],

	[100,  'atan', [2], "2", 1.1071487177940904],
	[101,  'atan', [Math.PI], "Math.PI", 1.2626272556789115],

	[120, 'atanh', [0.5], "0.5", 0.5493061443340548, 0.5493061443340548],

	[140, 'atan2', [1e-310, 2], "1e-310, 2", 5e-311],
	[141, 'atan2', [Math.PI, 2], "Math.PI, 2", 1.0038848218538872],

	[160,  'cbrt', [100], "100", 4.641588833612779],
	[161,  'cbrt', [Math.PI], "Math.PI", 1.4645918875615231],

	[180,   'cos', [n], n, 0.9924450321351935],
	[181,   'cos', [Math.PI], "Math.PI", -1],
	[182,   'cos', [bigN], "bigN", -0.10868049424995659], // creep says unique in Tor
	[183,   'cos', [-1e308], '-1e308', -0.8913089376870335],
	[184,   'cos', [13*Math.E], '13*Math.E', -0.7108118501064332],
	[185,   'cos', [57*Math.E], '57*Math.E', -0.5369116957490239],
	[186,   'cos', [21*Math.LN2], '21*Math.LN2', -0.40677759702517235],
	[187,   'cos', [51*Math.LN2], '51*Math.LN2', -0.7017203400855445],
	[188,   'cos', [21*Math.LOG2E], '21*Math.LOG2E', 0.43628480636189976],
	[189,   'cos', [25*Math.SQRT2], '25*Math.SQRT2', -0.6982689820462376],
	[190,   'cos', [50*Math.SQRT1_2], '50*Math.SQRT1_2', -0.6982689820462376],
	[191,   'cos', [21*Math.SQRT1_2], '21*Math.SQRT1_2', -0.6534063185820198],
	[192,   'cos', [17*Math.LOG10E], '17*Math.LOG10E', 0.45375574259827833],
	[193,   'cos', [2*Math.LOG10E], '2*Math.LOG10E', 0.6459044007438142],

	[200,  'cosh', [1], "1", 1.5430806348152437, 1.5430806348152437],
	[201,  'cosh', [Math.PI], "Math.PI", 11.591953275521519, 11.591953275521519],
	[202,  'cosh', [492*Math.LOG2E], '492*Math.LOG2E', 9.199870313877774e+307],
	[203,  'cosh', [502*Math.SQRT2], '502*Math.SQRT2', 1.046919966902314e+308],

	[220, 'expm1', [1], "1", 1.718281828459045],
	[221, 'expm1', [Math.PI], "Math.PI", 22.140692632779267],

	[240,   'exp', [n], n, 1.1308844209474893],
	[241,   'exp', [Math.PI], "Math.PI", 23.140692632779267],

	[260, 'hypot', [1,2,3,4,5,6], "1,2,3,4,5,6", 9.539392014169456, 9.539392014169458],
	[261, 'hypot', [bigN, bigN], "bigN, bigN", 8.288489826731114e+38, 8.288489826731116e+38],
	[262, 'hypot', [2*Math.E,-100], '2*Math.E,-100', 100.14767208675258, 100.14767208675259],
	[263, 'hypot', [6*Math.PI,-100], '6*Math.PI,-100', 101.7610227859332, 101.76102278593319],
	[264, 'hypot', [2*Math.LN2,-100], '2*Math.LN2,-100', 100.00960859865252, 100.0096085986525],
	[265, 'hypot', [Math.LOG2E,-100], 'Math.LOG2E,-100', 100.01040630344927, 100.01040630344929],
	[266, 'hypot', [Math.SQRT2,-100], 'Math.SQRT2,-100', 100.00999950005, 100.00999950004999],
	[267, 'hypot', [Math.SQRT1_2,-100], 'Math.SQRT1_2,-100', 100.00249996875078, 100.0024999687508],
	[268, 'hypot', [2*Math.LOG10E,-100], '2*Math.LOG10E,-100', 100.00377216279418, 100.00377216279416],

	[280,   'log', [n], n, -2.0955709236097197],
	[281,   'log', [Math.PI], "Math.PI", 1.1447298858494002],

	[300, 'log1p', [n], n, 0.11600367575630613, 0.11600367575630613],
	[301, 'log1p', [Math.PI], "Math.PI", 1.4210804127942926, 1.4210804127942926],

	[320, 'log10', [n], n, -0.9100948885606021, -0.9100948885606022],
	[321, 'log10', [Math.PI], "Math.PI", 0.49714987269413385, 0.49714987269413385],
	[322, 'log10', [Math.E], "Math.E", 0.4342944819032518, 0.4342944819032518],
	[323, 'log10', [34*Math.E], '34*Math.E', 1.965773398945507, 1.965773398945507],
	[324, 'log10', [Math.LN2], "Math.LN2", -0.1591745389548616, -0.1591745389548616],
	[325, 'log10', [11*Math.LN2], '11*Math.LN2', 0.8822181462033635, 0.8822181462033635],
	[326, 'log10', [Math.LOG2E], "Math.LOG2E", 0.15917453895486158, 0.15917453895486158],
	[327, 'log10', [43*Math.LOG2E], '43*Math.LOG2E', 1.7926429945344482, 1.792642994534448],
	[328, 'log10', [Math.LOG10E], "Math.LOG10E", -0.36221568869946325, -0.3622156886994632],
	[329, 'log10', [7*Math.LOG10E], '7*Math.LOG10E', 0.48288235131479357, 0.4828823513147936],
	[330, 'log10', [Math.SQRT1_2], "Math.SQRT1_2", -0.15051499783199057, -0.15051499783199057],
	[331, 'log10', [2*Math.SQRT1_2], '2*Math.SQRT1_2', 0.15051499783199063, 0.1505149978319906],
	[332, 'log10', [Math.SQRT2], "Math.SQRT2", 0.15051499783199063, 0.1505149978319906],

	[340,   'sin', [bigN], "bigN", 0.994076732536068], // creep says unique in Tor
	[341,   'sin', [Math.PI], "Math.PI", 1.2246467991473532e-16], // creep says unique in Tor
	[342,   'sin', [39*Math.E], "39*Math.E", -0.7181630308570678],
	[343,   'sin', [35*Math.LN2], "35*Math.LN2", -0.765996413898051],
	[344,   'sin', [110*Math.LOG2E], "110*Math.LOG2E", 0.9989410140273757],
	[345,   'sin', [7*Math.LOG10E], "7*Math.LOG10E", 0.10135692924965614],
	[346,   'sin', [35*Math.SQRT1_2], "35*Math.SQRT1_2", -0.37463575478582023],
	[347,   'sin', [21*Math.SQRT2], "21*Math.SQRT2", -0.9892668187780497],

	[360,  'sinh', [1], "1", 1.1752011936438014, 1.1752011936438014],
	[361,  'sinh', [Math.PI], "Math.PI", 11.548739357257748, 11.548739357257748],
	[362,  'sinh', [Math.E], "Math.E", 7.544137102816975, 7.544137102816975],
	[363,  'sinh', [Math.LN2], "Math.LN2", 0.75, 0.75],
	[364,  'sinh', [Math.LOG2E], "Math.LOG2E", 1.9978980091062795, 1.9978980091062797],
	[365,  'sinh', [492*Math.LOG2E], '492*Math.LOG2E', 9.199870313877774e+307, "Infinity"],
	[366,  'sinh', [Math.LOG10E], "Math.LOG10E", 0.44807597941469024, 0.4480759794146903],
	[367,  'sinh', [Math.SQRT1_2], "Math.SQRT1_2", 0.7675231451261164, 0.7675231451261164],
	[368,  'sinh', [Math.SQRT2], "Math.SQRT2", 1.935066822174357, 1.9350668221743568],
	[369,  'sinh', [502*Math.SQRT2], '502*Math.SQRT2', 1.046919966902314e+308, "Infinity"],

	[380,  'sqrt', [n], n, 0.3507135583350036],
	[381,  'sqrt', [Math.PI], "Math.PI", 1.7724538509055159],

	[400,   'tan', [-1e308], "-1e308", 0.5086861259107568],
	[401,   'tan', [Math.PI], "Math.PI", -1.2246467991473532e-16],
	[402,   'tan', [6*Math.E], '6*Math.E', 0.686676154645243],
	[403,   'tan', [6*Math.LN2], '6*Math.LN2', 1.618281713571588],
	[404,   'tan', [10*Math.LOG2E], '10*Math.LOG2E', -3.353712870537601],
	[405,   'tan', [17*Math.SQRT2], '17*Math.SQRT2', -1.922295546179998],
	[406,   'tan', [34*Math.SQRT1_2], '34*Math.SQRT1_2', -1.922295546179998],
	[407,   'tan', [10*Math.LOG10E], '10*Math.LOG10E', 2.5824856130712437],

	[420,  'tanh', [n], n, 0.12238344189440875, 0.12238344189440872],
	[421,  'tanh', [Math.PI], "Math.PI", 0.99627207622075, 0.9962720762207501],

	[440,   'pow', [n,-100], n+",-100", 1.0220893335845176e+91],
	[441,   'pow', [Math.PI,-100], "Math.PI,-100", 1.9275814160560185e-50],
	[442,   'pow', [Math.E,-100], "Math.E,-100", 3.720075976020851e-44],
	[443,   'pow', [Math.LN2,-100], "Math.LN2,-100", 8269017203802410],
	[444,   'pow', [Math.LN10,-100], "Math.LN10,-100", 6.003867926738811e-37],
	[445,   'pow', [Math.LOG2E,-100], "Math.LOG2E,-100", 1.2093335584550061e-16],
	[446,   'pow', [Math.LOG10E,-100], "Math.LOG10E,-100", 1.665592934758592e+36],
	[447,   'pow', [Math.SQRT1_2,-100], "Math.SQRT1_2,-100", 1125899906842611.5],
	[448,   'pow', [Math.SQRT2,-100], "Math.SQRT2,-100", 8.881784197001154e-16]
]


function outputMath() {
	// TZP
	get_tzp()

	// POLYFILLS
	const acosh = x => Math.log(x + Math.sqrt(x * x - 1))
	const asinh = x => {
		const absX = Math.abs(x)
		if (absX < Math.pow(2, -28)) {
			return x
		}
		const w = (
			absX > Math.pow(2, 28) ? Math.log(absX) + Math.LN2 :
			absX > 2 ? Math.log(2 * absX + 1 / Math.sqrt(x * x + 1)) :
			Math.log1p(absX + (x * x) / (1 + Math.sqrt(1 + (x * x))))
    )
		return x > 0 ? w : -w
	}
	const atanh = x => Math.log((1 + x) / (1 - x)) / 2
	const cosh = x => (Math.exp(x) + Math.exp(-x)) / 2
	function hypot(array) {
		let i, s = 0,
			max = 0,
			isInfinity = false,
			len = array.length
		for (i = 0; i < len; ++i) {
			const arg = Math.abs(+array[i])
			if (arg === Infinity) {
				isInfinity = true
			}
			if (arg > max) {
				s *= (max / arg) * (max / arg)
				max = arg
			}
			s += arg === 0 && max === 0 ? 0 : (arg / max) * (arg / max)
		}
		return isInfinity ? Infinity : (max === Infinity ? Infinity : max * Math.sqrt(s))
	}
	const log1p = x => {
		const nearX = (x + 1) - 1
		return (
			x < -1 || x !== x ? NaN :
			x === 0 || x === Infinity ? x :
			nearX === 0 ? x :
			x * (Math.log(x + 1) / nearX)
		)
	}
	const log2 = x => Math.log(x) * Math.LOG2E
	const log10 = x => Math.log(x) * Math.LOG10E
	const sinh = x => (Math.exp(x) - Math.exp(-x)) / 2
	const tanh = x => {
		const a = Math.exp(+x)
		const b = Math.exp(-x)
		return a == Infinity ? 1 : b == Infinity ? -1 : (a - b) / (a + b)
	}

	// BUILD TEST RESULTS
	let	math1 = [],	// functions
		math2 = [], // polyfills
		display = [],
		numbers = [] // numbers which make a difference
		let polymatch = [],
		fnmatch = [], // do not match control
		diffs = [] // fn + poly don't match

	let prevFn = "start", demarc = false,
		strDemarc = "----------------------------------------------------<br>",
		vPad = 19, // value tested
		fPad = vPad + 7, // function + value
		rPad = 23, // result
		nPad = 5 // user number: 5 means k indents by 2, and k+"p1"/"p2" is covered in diffs

	for(let i=0; i < fns.length; i++) {
		let fn = fns[i]
		let k = fn[0] // user defined number
		let kpad = (k.toString()).padStart(nPad)
		let fnResult = (Math[fn[1]](...fn[2])).toString()
		let fnValue = fn[3].toString()
		let fnControl = fn[4].toString()
		let fnName = fn[1].toString()

		// poly tests
		let poly1Result = ""
		let poly1Control = ""
		if (fn[5] !== undefined && fn[5] !== "") {
			poly1Control = fn[5].toString()
			if (fnName == "acosh") {
				poly1Result = acosh(...fn[2])
			} else if (fnName == "asinh") {
				poly1Result = asinh(...fn[2])
			} else if (fnName == "atanh") {
				poly1Result = atanh(...fn[2])
			} else if (fnName == "cosh") {
				poly1Result = cosh(...fn[2])
			} else if (fnName == "hypot") {
				// i need to pass an array
				poly1Result = hypot([...fn[2]])
			} else if (fnName == "log1p") {
				poly1Result = log1p(...fn[2])
			} else if (fnName == "log2") {
				poly1Result = log2(...fn[2])
			} else if (fnName == "log10") {
				poly1Result = log10(...fn[2])
			} else if (fnName == "sinh") {
				poly1Result = sinh(...fn[2])
			} else if (fnName == "tanh") {
				poly1Result = tanh(...fn[2])
			}
			poly1Result = poly1Result.toString()
			//console.debug(k, fn[3], fnName, poly1Control, poly1Result)
		}

		// fn result
		let isFnDiff = false
		if (fnResult !== fnControl) {
			isFnDiff = true
			fnmatch.push(k+":"+fnName+"("+fn[3]+"):"+fnControl +":"+fnResult)
			numbers.push(k)
		}
		math1.push(k+":"+fnResult)

		// poly1 results
		let isPolyDiff = false, isDiff = false
		if (poly1Result !== "") {
			if (poly1Result !== poly1Control) {
				isPolyDiff = true
				polymatch.push(k+"p1:"+fnName+"("+fn[3]+"):"+poly1Control +":"+poly1Result)
				numbers.push(k+"p1")
			}
			math2.push(k+"p1:"+poly1Result)
			// does not match fn
			if (poly1Result !== fnResult) {
				isDiff = true
				diffs.push(k+"p1:"+fnName+"("+fn[3]+"):"+fnResult +":"+poly1Result)
			}
		}

		// color & pad
		if (isFnDiff) {
			fnResult = s1.trim() + fnResult.padStart(rPad) + sc
		} else {
			fnResult = fnResult.padStart(rPad)
		}
		if (isPolyDiff) {
			poly1Result = s1.trim() + poly1Result.padStart(rPad) + sc
		} else {
			poly1Result = poly1Result.padStart(rPad)
		}
		if (isDiff) {
			poly1Result += s1 + "[match]" +sc
		}

		if (poly1Result !== "") {
			fnResult += ", " + poly1Result
		}

		// demarcate each function
		if (prevFn !== fnName) {demarc = true} else {demarc = false}
		if (demarc == true) {
			display.push(s3.trim() + strDemarc + fnName.toUpperCase() + sc)
		}
		display.push(kpad+": "+ s3 + fnValue.padEnd(vPad) + sc + ": " +fnResult)

		// remember last function
		prevFn = fn[1]
	}

	// numbers
	numbers.sort((a,b) => a-b)
	numbers = numbers.filter(function(item, position) {return numbers.indexOf(item) === position})
	numbers.sort((a,b) => a-b)
	let numstr = "none"
	if (numbers.length > 0) {
		numstr = numbers.join(", ")
	}
	dom.num = numstr

	// diffs
	function output_diffs(array, type) {
		let output = []
		if (array.length > 0) {
			for(let i=0; i < array.length; i++) {
				let part0 = array[i].split(":")[0]
					part0 = (part0.toString()).padStart(nPad)
				let part1 = array[i].split(":")[1]
					part1 = (part1.toString()).padStart(fPad)
				let part2 = array[i].split(":")[2]
					part2 = (part2.toString()).padStart(rPad)
				let part3 = array[i].split(":")[3]
				output.push(part0 + ":" + s3 + part1 + sc + " s/be " + s3.trim() + part2 + sc + " got" + s1 + part3 + sc)
			}
			document.getElementById("diff" + type).innerHTML = output.join("<br>")
		} else {
			document.getElementById("diff" + type).innerHTML = "they all match"
		}
	}
	output_diffs(diffs, 0)
	output_diffs(fnmatch, 1)
	output_diffs(polymatch, 2)

	// hashes
	let hash1 = sha1(math1.join())
	let hash2 = sha1(math2.join())
	let hash0 = sha1(hash1 + hash2)
		//ToDo: assign short codes
	dom.hash1.innerHTML = hash1 + s3 +"["+ math1.length +"]"+sc

	if (math2.length > 0) {
		dom.hash2.innerHTML = hash2 + s3 +"["+ math2.length +"]"+sc
	} else {
		dom.hash2.innerHTML = "none run"
	}

	dom.tzphash.innerHTML = tzphash + (isFF ? tzpcode : "")
	dom.hash0.innerHTML = hash0 // ToDo: add [CODE] or [NEW]
	// data
	let bigNstr = "* bigN = " + bigN
	dom.mathdata.innerHTML = (s12 +"TZP").padStart(40) + "<br>" + strDemarc + sc
		+ tzphash + " " + tzpcode + "<br>"	+ tzpdisplay.join("<br>") + "<br><br>"
		+ (s3.trim() +"NEW TESTS").padStart(43) + "<br>" + strDemarc + sc
		+ hash0 + "<br>" + numstr + "<br><br>"
		+ bigNstr.padStart(45) + "<br>" + display.join("<br>")


}

outputMath()

</script>
</body>
</html>
